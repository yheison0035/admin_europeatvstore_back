generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // Cambia a mysql o sqlite si usas otro
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////

enum Role {
  SUPER_ADMIN
  COORDINADOR
  ADMIN
  ASESOR
  AUXILIAR
  BODEGUERO
  VENTAS
}

enum Status {
  ACTIVO
  INACTIVO
  PENDIENTE
  ELIMINADO
}

enum PaymentMethod {
  EFECTIVO
  BANCOLOMBIA
  TRANSFERENCIA
  DATAFONO
  ADDI
}

enum PaymentStatus {
  PENDIENTE
  EN_VALIDACION
  PLAN_SEPARE
  PAGADA
  RECHAZADA
  VENCIDO
  REEMBOLSADO
  ANULADO
}

enum SaleStatus {
  NUEVA
  EN_PROCESO
  PENDIENTE
  APROBADA
  RECHAZADA
  CANCELADA
  FACTURADA
  DESPACHADA
  ENTREGADA
  DEVUELTA
}

enum ExpenseType {
  ARRIENDO
  SERVICIOS_PUBLICOS
  EMPLEADOS
  TRANSPORTE
  PEDIDOS
  PLAN_CELULAR
  PLAN_INTERNET
  ASEO
  MANTENIMIENTO
  PUBLICIDAD
  IMPUESTOS
  COMISIONES
  OTROS
}

enum OrderSource {
  CRM
  ECOMMERCE
}

enum ShippingStatus {
  PENDIENTE
  ASIGNADO_TRANSPORTADORA
  EN_CAMINO
  ENTREGADO
  DEVUELTO
  FALLIDO
}

//////////////////////////////////////////////////
// MODELOS
//////////////////////////////////////////////////

model User {
  id         Int       @id @default(autoincrement())
  role       Role      @default(ASESOR)
  name       String    @default("SIN NOMBRE")
  email      String    @unique
  phone      String?
  address    String?
  birthdate  DateTime?
  document   String?
  department String?
  city       String?
  status     Status    @default(ACTIVO)
  password   String
  avatar     String?

  localId Int?
  local   Local? @relation("LocalUsers", fields: [localId], references: [id], onDelete: SetNull)

  managedLocals      Local[]     @relation("LocalManager")
  createdInventories Inventory[] @relation("InventoryCreatedBy")
  updatedInventories Inventory[] @relation("InventoryUpdatedBy")

  sales Sale[] @relation("UserSales")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////

model Customer {
  id            Int     @id @default(autoincrement())
  type_document String?
  document      String? @unique
  name          String
  email         String?
  phone         String?
  department    String?
  city          String?
  address       String?
  status        Status  @default(ACTIVO)

  localId Int?
  local   Local? @relation(fields: [localId], references: [id], onDelete: SetNull)

  sales Sale[] @relation("CustomerSales")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////

model Provider {
  id          Int     @id @default(autoincrement())
  name        String
  contactName String?
  phone       String?
  email       String?
  city        String?
  department  String?
  address     String?
  productType String?
  status      Status  @default(ACTIVO)

  inventories Inventory[] @relation("ProviderProducts")
  expenses    Expense[]   @relation("ProviderExpenses")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////

model Local {
  id         Int     @id @default(autoincrement())
  name       String
  address    String?
  department String?
  city       String?
  phone      String?
  status     Status  @default(ACTIVO)

  managerId Int?
  manager   User? @relation("LocalManager", fields: [managerId], references: [id])

  users       User[]      @relation("LocalUsers")
  inventories Inventory[] @relation("LocalInventory")
  expenses    Expense[]   @relation("LocalExpenses")
  sales       Sale[]      @relation("LocalSales")
  categories  Category[]  @relation("LocalCategory")
  brand       Brand[]     @relation("LocalBrand")

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  Customer  Customer[]
}

//////////////////////////////////////////////////

model Category {
  id          Int     @id @default(autoincrement())
  name        String
  description String?
  status      Status  @default(ACTIVO)
  localId     Int?

  inventories Inventory[] @relation("CategoryProducts")
  local       Local?      @relation("LocalCategory", fields: [localId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////

model Brand {
  id          Int     @id @default(autoincrement())
  name        String
  description String?
  status      Status  @default(ACTIVO)
  localId     Int?

  inventories Inventory[] @relation("BrandProducts")
  local       Local?      @relation("LocalBrand", fields: [localId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////

model Inventory {
  id            Int     @id @default(autoincrement())
  name          String
  description   String?
  slug          String? @unique
  purchasePrice Float
  oldPrice      Float?
  salePrice     Float
  status        Status  @default(ACTIVO)
  barcode       String? @unique

  localId    Int?
  providerId Int?
  categoryId Int?
  brandId    Int?

  createdById Int?
  updatedById Int?

  createdBy User?     @relation("InventoryCreatedBy", fields: [createdById], references: [id])
  updatedBy User?     @relation("InventoryUpdatedBy", fields: [updatedById], references: [id])
  local     Local?    @relation("LocalInventory", fields: [localId], references: [id], onDelete: SetNull)
  provider  Provider? @relation("ProviderProducts", fields: [providerId], references: [id], onDelete: SetNull)
  category  Category? @relation("CategoryProducts", fields: [categoryId], references: [id], onDelete: SetNull)
  brand     Brand?    @relation("BrandProducts", fields: [brandId], references: [id], onDelete: SetNull)

  variants InventoryVariant[]
  images   InventoryImage[]
  features       InventoryFeature[]
  specifications InventorySpecification[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model InventoryVariant {
  id          Int    @id @default(autoincrement())
  sequence    Int    @unique @default(autoincrement())
  color       String
  stock       Int    @default(0)
  sku         String @unique

  isActive    Boolean  @default(true)
  
  inventoryId Int

  inventory Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  saleItems SaleItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model InventoryImage {
  id          Int    @id @default(autoincrement())
  url         String
  publicId    String
  inventoryId Int
  position    Int    @default(0)

  inventory Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

model InventoryFeature {
  id          Int    @id @default(autoincrement())
  title       String
  inventoryId Int
  order       Int    @default(0)

  inventory Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

model InventorySpecification {
  id          Int    @id @default(autoincrement())
  key         String
  value       String
  inventoryId Int
  order       Int    @default(0)

  inventory Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

//////////////////////////////////////////////////

model Expense {
  id            Int            @id @default(autoincrement())
  concept       String
  type          ExpenseType
  amount        Float
  paymentMethod PaymentMethod?
  paidTo        String?
  notes         String?
  status        Status         @default(ACTIVO)
  expenseDate   DateTime

  providerId Int?
  localId    Int

  provider Provider? @relation("ProviderExpenses", fields: [providerId], references: [id], onDelete: SetNull)
  local    Local    @relation("LocalExpenses", fields: [localId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////

model Sale {
  id            Int           @id @default(autoincrement())
  code          String        @unique
  totalAmount   Float
  paymentMethod PaymentMethod
  saleStatus    SaleStatus    @default(NUEVA)
  paymentStatus PaymentStatus @default(PENDIENTE)
  saleDate      DateTime      @default(now())
  notes         String?

  source        OrderSource   @default(CRM)
  ecommerceCustomerId Int?

  shippingStatus ShippingStatus @default(PENDIENTE)

  wompiTransactionId String?
  wompiReference     String?
  wompiStatus        String?
  wompiPayload       Json?

  customerId Int
  localId    Int
  userId     Int

  customer Customer @relation("CustomerSales", fields: [customerId], references: [id])
  ecommerceCustomer EcommerceCustomer? @relation("EcommerceOrders", fields: [ecommerceCustomerId], references: [id])

  local    Local    @relation("LocalSales", fields: [localId], references: [id])
  user     User     @relation("UserSales", fields: [userId], references: [id])

  items SaleItem[] @relation("SaleItems")

  shipment Shipment?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//////////////////////////////////////////////////
// Tabla intermedia para los productos vendidos
//////////////////////////////////////////////////

model SaleItem {
  id       Int   @id @default(autoincrement())
  quantity Int
  price    Float
  subtotal Float
  discount Float @default(0)

  saleId             Int
  inventoryVariantId Int

  sale    Sale             @relation("SaleItems", fields: [saleId], references: [id], onDelete: Cascade)
  variant InventoryVariant @relation(fields: [inventoryVariantId], references: [id])

  createdAt DateTime @default(now())
}

//////////////////////////////////////////////////
// ECOMMERCE
//////////////////////////////////////////////////

model EcommerceCustomer {
  id Int @id @default(autoincrement())

  email String @unique
  firstName String
  lastName String
  phone String

  documentNumber String?

  department String
  city String
  address String
  addressDetail String?
  neighborhood String?

  billingSameAsShipping Boolean @default(true)
  billingFirstName String?
  billingLastName String?
  billingPhone String?
  billingAddress String?

  isHardToAccess Boolean @default(false)

  localId Int @default(3)

  orders Sale[] @relation("EcommerceOrders")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Shipment {
  id Int @id @default(autoincrement())

  saleId Int @unique
  status ShippingStatus @default(PENDIENTE)

  carrier String?
  trackingNumber String?

  shippedAt DateTime?
  deliveredAt DateTime?
  notes String?

  sale Sale @relation(fields: [saleId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
